<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>/topics/17-security [missing course]</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <style>
  pre code {
      background-color: lightgoldenrodyellow;
      border-radius: 1.0rem;
      display: block;
      font-size: 0.8rem;
      padding: 1.0rem;
  }

  pre code.sourceCode {
      background-color: lightgoldenrodyellow;
  }

  code {
      background-color: lightgoldenrodyellow;
      border-radius: 0.3rem;
      padding: 0.1rem 0.2rem;
  }

  figcaption {
      font-size: 0.9rem;
      font-style: italic;
      text-align: center;
  }

  #before {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid black;
  }

  #after {
      display: flex;
      justify-content: space-between;
      border-top: 1px solid black;
  }
  </style>
</head>
<body>
<div id="banner">
    <img src="media/header.jpg" alt="Course Header">
</div>
<div id="before">
    The Missing Course
    <div id="before-links">
        <a href="../.." title="Course Home">Home</a> |
        <a href="https://github.com/glesica/missing-course" title="Course GitHub Page">GitHub</a>
    </div>
</div>
<h1 id="security">Security</h1>
<p>Security is a broad field, so we will cover a smattering of topics that are likely to be useful to at least many of you.</p>
<h1 id="passwords">Passwords</h1>
<p>The most obvious way to handle passwords in an application is to simply store them somewhere (in a database, perhaps) and when a user attempts to log in, look up the password that corresponds to the user and verify that it matches.</p>
<p>This actually works just fine, but it has some very unfortunate consequences in the event that the database where the passwords are stored is compromised since the attackers get immediate access to all user credentials. Now, you might think that this isn’t a big deal since, if the database has been compromised, the attackers already have access to every user’s data anyway, but, unfortunately, people tend to re-use passwords across applications. This means that a password stolen from an inconsequential application might give the attackers access to a user’s email or bank account.</p>
<p>To mitigate this issue, we hash passwords before they are stored. This means that we apply a one-way function to transform the password into a different value that can’t be easily converted back into the original password. To do this, we use a “hash function”. This is a function <code>h(x) -&gt; y</code> with the property that there exists no (reasonable) function <code>h'(y) -&gt; x</code>.</p>
<p>One such hash function is called SHA-256. This is the one we will use in our examples.</p>
<p>Hashing passwords before storing them goes a long way to fixing the problem described above, but attackers can still reverse a hash function, at least probabilistically, using a tool commonly called a Rainbow Table. This is, essentially, a table of pre-hashed passwords either randomly generated or known to be in common use. Once such a table has been computed, it is trivial (and very fast) to convert a hash back into the original password (assuming the hash exists in the table).</p>
<p>The prevent this, we apply what is known as a “salt” to each password before it is hashed. Essentially, we take the user’s password, add some random data to it to make it stronger, hash the salted password, and then store the hashed password along with the salt value in our database. See the pseudo-Python below.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hash_password(pw):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    salt <span class="op">=</span> random_salt()</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    salted_pw <span class="op">=</span> pw <span class="op">+</span> salt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    hashed_pw <span class="op">=</span> sha256(salted_pw)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (hashed_pw, salt)</span></code></pre></div>
<p>Now, let’s assume that we use a single, randomly chosen, lower-case letter as the salt value. This means that an effective rainbow table must hash each password 26 times, once with each possible salt value. This is quite a bit more work, and makes the table take up quite a bit more space on disk. If we make our salt values four characters long and allow all alphanumeric characters then a rainbow table with a given level of effectiveness will be <span class="math inline">62<sup>4</sup> = 14, 776, 336</span> times as large. That’s already entirely impractical for a table that contains more than just a few potential passwords.</p>
<h2 id="example">Example</h2>
<p>Take a look the scripts below and play around with hashing various passwords, generating rainbow tables, and looking up passwords in those tables.</p>
<ul>
<li><a href="hash_password.py">hash_password.py</a></li>
<li><a href="rainbow_table.py">rainbow_table.py</a></li>
<li><a href="table_lookup.py">table_lookup.py</a></li>
</ul>
<h1 id="sql-injection">SQL Injection</h1>
<p>SQL injection is a common attack used against applications that store their data in a SQL database. It works by tricking a program into inserting code into a SQL statement instead of just data.</p>
<figure>
<img src="https://imgs.xkcd.com/comics/exploits_of_a_mom.png" alt="Exploits of a Mom (xkcd)" /><figcaption aria-hidden="true">Exploits of a Mom (xkcd)</figcaption>
</figure>
<p>For example, in the famous cartoon above, the child’s name contains SQL code that is designed in such a way that it is likely to be syntactically valid when directly interpolated into a SQL query, but when it is run it attempts to delete the database table called “Students”.</p>
<p>The reason this sort of thing works is that we build up SQL code inside of our programs, then execute that code on the fly. The same thing would be possible with ordinary programming languages if we created code on the fly. In fact, many languages have the ability to evaluate snippets of their own code, but doing so is generally considered a bad idea because it can leave a program open to similar injection attacks. For example, Python supports this through the <code>eval</code> function:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span>(<span class="st">&quot;print(&#39;hello&#39;)&quot;</span>)</span></code></pre></div>
<p>Typically, SQL injection is prevented by correctly parameterizing queries. Different database client libraries for different programming languages may use different syntax for doing this, but most provide similar capabilities. For exampe, the query below is vulnerable to injection:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cursor.execute(<span class="st">&quot;SELECT * FROM users WHERE name=&#39;</span><span class="sc">%s</span><span class="st">&#39;&quot;</span> <span class="op">%</span> name)</span></code></pre></div>
<p>On the other hand, this query is not, because it substitutes the name into the query using the SQL library as opposed to simple string interpolation:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cursor.execute(<span class="st">&quot;SELECT * FROM users WHERE name=?&quot;</span>, (name,))</span></code></pre></div>
<p>A good rule of thumb is to never include user input in code that will be run on the fly unless it has been properly escaped / sanitized. Also keep in mind that this isn’t something you want to try to do yourself because it is easy to forget an edge case and leave your program open to injection attacks.</p>
<h2 id="example-1">Example</h2>
<p>Take a look at <a href="user-lookup.py">user-lookup.py</a> for an example. This script accepts a user name and a password and prints a secret word, specific to that user, if the password is correct.</p>
<p>The first time it is run it will create a database file called <code>users.db</code>. You can reset the database by deleting the file. You can also interact with the database directly using the <code>sqlite3</code> tool, if you have it installed.</p>
<pre><code>./user-lookup.py Travis changeme</code></pre>
<p>If you enter the wrong password, however, you’ll get back an error message instead of the super secret word.</p>
<p>Try running it for “George” as well (his password is “sosecure”). As you can see, George and Travis have different secrets.</p>
<p>Now, let’s inject some SQL into the program by running the script like this:</p>
<pre><code>./user-lookup.py George &quot;&#39; OR password &lt;&gt; &#39;&quot;</code></pre>
<p>What happened? Why did it produce that result? How did it give us George’s secret without the correct password?</p>
<h1 id="buffer-overruns">Buffer Overruns</h1>
<p>A buffer overrun occurs when a program reads memory beyond the end of an array. This is impossible to do in most languages, but it can happen in languages like C that allow direct access to memory and, in particular, pointer arithmetic.</p>
<p>Pointer arithmetic is basically what it sounds like. A pointer is just an address in memory, which means that it is an integer since “memory” is essentially just a linear array of bytes (see below).</p>
<figure>
<img src="media/17-memory-layout.png" alt="Memory Layout" /><figcaption aria-hidden="true">Memory Layout</figcaption>
</figure>
<p>In C, an integer can be used as a pointer, and a pointer can be used as an integer, they are essentially the same thing. Therefore, pointers can be added and subtracted. This means that if I have a pointer to a particular memory location, let’s say <code>0xFF56</code>, I can add one to it and now I have a pointer to the memory location <code>0xFF57</code>. Now, if I dereference this pointer, I get whatever data happens to be stored at <code>0xFF57</code>.</p>
<p>In fact, this is essentially how arrays work in C. The syntax <code>myArray[5]</code> is actually just shorthand for something like:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">*(</span>myArray <span class="op">+</span> <span class="dv">5</span><span class="op">)</span></span></code></pre></div>
<p>As you might guess, then, an array variable in C is very similar to a pointer to the first element (the reality is a little more complicated, but it’s a reasonable approximation). However, this means that there is no way for the computer to know how long you expect a given array to be, it knows where the array starts and not much else.</p>
<p>Because of everything described above, it is possible to read beyond the end of an array. The result of doing so depends on what is (or was) stored adjacent to the array data. An attacker can use a buffer overrun bug to attempt to access sensitive data, like encryption keys.</p>
<h2 id="example-2">Example</h2>
<p>The file <code>secrets.c</code> contains a program that loads secrets and names into memory and then provides access to the names by index. For example, <code>./secrets 0</code> prints “George” because that is the first value stored in the <code>names</code> array. However, if we run <code>./secrets 2</code> we get a surprise. Instead of a name (or an error message), we get one of the secret values!</p>
<p>You can build the program by running <code>gcc -o secrets secrets.c</code>, assuming you have the GCC C compiler installed.</p>

<div id="after">
    <a href="#">Back to top</a>
    <div id="after-links">
        <a href="../.." title="Course Home">Home</a> |
        <a href="https://github.com/glesica/missing-course" title="Course GitHub Page">GitHub</a>
    </div>
</div>
</body>
</html>
